name: Android Release Pipeline
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: NOTIFY BUILD STARTED
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_start:
    name: ğŸš€ Notify Build Started
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram â€” Build Started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="ğŸ”¨ *Build Pipeline Started*

  ğŸ“¦ *App:* DevPocket
  ğŸ·ï¸ *Version:* \`${{ github.ref_name }}\`
  ğŸ‘¤ *Triggered by:* ${{ github.actor }}
  ğŸ• *Time:* $(date '+%Y-%m-%d %H:%M:%S UTC')
  ğŸ”— [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

  _Building your APK... hang tight_ âš™ï¸"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: BUILD
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ”§ Build APK
    runs-on: ubuntu-latest
    needs: notify_start
    outputs:
      apk_size: ${{ steps.apk_info.outputs.apk_size }}
      build_time: ${{ steps.apk_info.outputs.build_time }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Start Build Timer
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build APK
        run: flutter build apk --release

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/DevPocket-Release.apk

      - name: Get APK Info
        id: apk_info
        run: |
          SIZE=$(du -sh build/app/outputs/flutter-apk/DevPocket-Release.apk | cut -f1)
          END=$(date +%s)
          ELAPSED=$(( END - ${{ steps.timer.outputs.start }} ))
          MINUTES=$(( ELAPSED / 60 ))
          SECONDS=$(( ELAPSED % 60 ))
          echo "apk_size=$SIZE" >> $GITHUB_OUTPUT
          echo "build_time=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/DevPocket-Release.apk
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: NOTIFY BUILD RESULT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_build_result:
    name: ğŸ“£ Notify Build Result
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Send Telegram â€” Build Success
        if: needs.build.result == 'success'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="âœ… *Build Successful!*

  ğŸ“¦ *App:* DevPocket
  ğŸ·ï¸ *Version:* \`${{ github.ref_name }}\`
  ğŸ“ *APK Size:* ${{ needs.build.outputs.apk_size }}
  â±ï¸ *Build Time:* ${{ needs.build.outputs.build_time }}
  ğŸ”— [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

  _Waiting for your approval to publish_ ğŸ‘‡"

      - name: Send Telegram â€” Build Failed
        if: needs.build.result == 'failure'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="âŒ *Build Failed!*

  ğŸ“¦ *App:* DevPocket
  ğŸ·ï¸ *Version:* \`${{ github.ref_name }}\`
  ğŸ‘¤ *Triggered by:* ${{ github.actor }}
  ğŸ”— [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

  _Fix the errors and push again_ ğŸ”§"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: APPROVAL GATE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approval_gate:
    name: ğŸ” Awaiting Approval
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    environment: production
    steps:
      - name: Send Telegram â€” Approval Request with Buttons
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="ğŸ” *Approval Required*

  A new release is ready and waiting for your go-ahead.

  ğŸ“¦ *App:* DevPocket
  ğŸ·ï¸ *Version:* \`${{ github.ref_name }}\`
  ğŸ“ *APK Size:* ${{ needs.build.outputs.apk_size }}
  â±ï¸ *Built in:* ${{ needs.build.outputs.build_time }}
  ğŸ‘¤ *By:* ${{ github.actor }}

  _Tap below or approve on GitHub_ ğŸ‘‡" \
            -d reply_markup="{
              \"inline_keyboard\": [[
                {\"text\": \"âœ… Approve on GitHub\", \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"},
                {\"text\": \"âŒ Reject on GitHub\", \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
              ],[
                {\"text\": \"ğŸ” View Full Logs\", \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
              ]]
            }"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5: RELEASE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: ğŸš€ Publish Release
    runs-on: ubuntu-latest
    needs: approval_gate
    steps:
      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: DevPocket-Release.apk
          generate_release_notes: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 6: NOTIFY RELEASE PUBLISHED
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_released:
    name: ğŸ‰ Notify Released
    runs-on: ubuntu-latest
    needs: release
    if: always()
    steps:
      - name: Send Telegram â€” Released Successfully
        if: needs.release.result == 'success'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="ğŸ‰ *DevPocket ${{ github.ref_name }} is LIVE!*

  Your app has been successfully published to GitHub Releases.

  ğŸ“¦ *APK Size:* ${{ needs.build.outputs.apk_size }}
  â±ï¸ *Total Pipeline:* check workflow
  ğŸŒ *Public Release URL:*
  https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}

  _Ship it and forget it_ ğŸ˜ğŸš€" \
            -d reply_markup="{
              \"inline_keyboard\": [[
                {\"text\": \"ğŸ“¥ Download APK\", \"url\": \"https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}\"}
              ]]
            }"

      - name: Send Telegram â€” Release Failed
        if: needs.release.result == 'failure'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="ğŸ’€ *Release Publishing Failed!*

  The build was approved but publishing crashed.

  ğŸ”— [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

  _Check the release job for errors_ ğŸ”§"
```

---

## Pipeline Flow
```
push tag
   â”‚
   â–¼
ğŸ”¨ Telegram: Build Started
   â”‚
   â–¼
âš™ï¸  Build APK (tracks size + time)
   â”‚
   â”œâ”€â”€ âŒ FAIL â†’ Telegram: Build Failed
   â”‚
   â–¼
âœ… Telegram: Build Success + APK info
   â”‚
   â–¼
ğŸ” Telegram: Approve/Reject buttons â†’ you tap â†’ GitHub UI approves
   â”‚
   â–¼
ğŸš€ Publish to GitHub Releases
   â”‚
   â–¼
ğŸ‰ Telegram: Live! with Download APK button