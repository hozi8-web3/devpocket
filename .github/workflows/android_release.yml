name: Android Release Pipeline
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: NOTIFY BUILD STARTED
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_start:
    name: Notify Build Started
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram â€” Build Started
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          MSG="ğŸ”¨ *Build Pipeline Started*%0A%0AğŸ“¦ *App:* DevPocket%0AğŸ·ï¸ *Version:* \`${VERSION}\`%0AğŸ‘¤ *Triggered by:* ${ACTOR}%0AğŸ• *Time:* $(date '+%Y-%m-%d %H:%M:%S UTC')%0AğŸ”— [View Workflow](https://github.com/${REPO}/actions/runs/${RUN_ID})%0A%0A_Building your APK\.\.\. hang tight_ âš™ï¸"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MSG}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: BUILD
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: notify_start
    outputs:
      apk_size: ${{ steps.apk_info.outputs.apk_size }}
      build_time: ${{ steps.apk_info.outputs.build_time }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Start Build Timer
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build APK
        run: flutter build apk --release

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/DevPocket-Release.apk

      - name: Get APK Info
        id: apk_info
        run: |
          SIZE=$(du -sh build/app/outputs/flutter-apk/DevPocket-Release.apk | cut -f1)
          END=$(date +%s)
          ELAPSED=$(( END - ${{ steps.timer.outputs.start }} ))
          MINUTES=$(( ELAPSED / 60 ))
          SECONDS=$(( ELAPSED % 60 ))
          echo "apk_size=$SIZE" >> $GITHUB_OUTPUT
          echo "build_time=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/DevPocket-Release.apk
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: NOTIFY BUILD RESULT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_build_result:
    name: Notify Build Result
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Send Telegram â€” Build Success
        if: needs.build.result == 'success'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ github.ref_name }}
          SIZE: ${{ needs.build.outputs.apk_size }}
          BUILD_TIME: ${{ needs.build.outputs.build_time }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          MSG="âœ… *Build Successful!*%0A%0AğŸ“¦ *App:* DevPocket%0AğŸ·ï¸ *Version:* \`${VERSION}\`%0AğŸ“ *APK Size:* ${SIZE}%0Aâ±ï¸ *Build Time:* ${BUILD_TIME}%0AğŸ”— [View Workflow](https://github.com/${REPO}/actions/runs/${RUN_ID})%0A%0A_Waiting for your approval to publish_ ğŸ‘‡"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MSG}"

      - name: Send Telegram â€” Build Failed
        if: needs.build.result == 'failure'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          MSG="âŒ *Build Failed!*%0A%0AğŸ“¦ *App:* DevPocket%0AğŸ·ï¸ *Version:* \`${VERSION}\`%0AğŸ‘¤ *Triggered by:* ${ACTOR}%0AğŸ”— [View Logs](https://github.com/${REPO}/actions/runs/${RUN_ID})%0A%0A_Fix the errors and push again_ ğŸ”§"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MSG}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: APPROVAL GATE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approval_gate:
    name: Awaiting Approval
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    environment: production
    steps:
      - name: Send Telegram â€” Approval Request with Buttons
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ github.ref_name }}
          SIZE: ${{ needs.build.outputs.apk_size }}
          BUILD_TIME: ${{ needs.build.outputs.build_time }}
          ACTOR: ${{ github.actor }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          MSG="ğŸ” *Approval Required*%0A%0AA new release is ready and waiting for your go-ahead\.%0A%0AğŸ“¦ *App:* DevPocket%0AğŸ·ï¸ *Version:* \`${VERSION}\`%0AğŸ“ *APK Size:* ${SIZE}%0Aâ±ï¸ *Built in:* ${BUILD_TIME}%0AğŸ‘¤ *By:* ${ACTOR}%0A%0A_Tap below to approve or reject on GitHub_ ğŸ‘‡"
          KEYBOARD="{\"inline_keyboard\":[[{\"text\":\"âœ… Approve on GitHub\",\"url\":\"https://github.com/${REPO}/actions/runs/${RUN_ID}\"},{\"text\":\"âŒ Reject on GitHub\",\"url\":\"https://github.com/${REPO}/actions/runs/${RUN_ID}\"}],[{\"text\":\"ğŸ” View Full Logs\",\"url\":\"https://github.com/${REPO}/actions/runs/${RUN_ID}\"}]]}"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MSG}" \
            -d reply_markup="${KEYBOARD}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5: RELEASE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: approval_gate
    steps:
      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: DevPocket-Release.apk
          generate_release_notes: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 6: NOTIFY RELEASE PUBLISHED
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_released:
    name: Notify Released
    runs-on: ubuntu-latest
    needs: release
    if: always()
    steps:
      - name: Send Telegram â€” Released Successfully
        if: needs.release.result == 'success'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          MSG="ğŸ‰ *DevPocket ${VERSION} is LIVE!*%0A%0AYour app has been successfully published to GitHub Releases\.%0A%0AğŸŒ *Release URL:*%0Ahttps://github.com/${REPO}/releases/tag/${VERSION}%0A%0A_Ship it and forget it_ ğŸ˜ğŸš€"
          KEYBOARD="{\"inline_keyboard\":[[{\"text\":\"ğŸ“¥ Download APK\",\"url\":\"https://github.com/${REPO}/releases/tag/${VERSION}\"}]]}"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MSG}" \
            -d reply_markup="${KEYBOARD}"

      - name: Send Telegram â€” Release Failed
        if: needs.release.result == 'failure'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          MSG="ğŸ’€ *Release Publishing Failed!*%0A%0AThe build was approved but publishing crashed\.%0A%0AğŸ”— [View Logs](https://github.com/${REPO}/actions/runs/${RUN_ID})%0A%0A_Check the release job for errors_ ğŸ”§"
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MSG}"